<!DOCTYPE html>
<html>
<head>
	<title>运输车次时间记录</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<link rel="stylesheet" type="text/css" href="../css/common.css">
	<link rel="stylesheet" type="text/css" href="../css/goodsTime.css">
</head>
<body>
	<div class="bar">
		<span id="goToLogin"><返回</span>
		运输车次时间记录
	</div>
	<p class="select-box mt-30">
		<input id="carNum" />
		<select>
			<option>车次编号</option>
		</select>
	</p>
	<div class="table-box mt-30">
		<table border="1" cellspacing="0" cellpadding="0" width="100%">
			<tbody id="info"></tbody>
		</table>
	</div>
	<div class="table-box mt-30">
		<table border="1" cellspacing="0" cellpadding="0" width="100%">
			<tbody id="list"></tbody>
		</table>
	</div>
	<div class="button-box btn-box-small mt-30">
		<p>
			<button id="setTime">到厂确定</button>
			<button id="outF">出厂确定</button>
			<button id="arrive">到达工地确定</button>
		</p>
		<p class="mt-30">
			<button id="dzwcqr">吊装完成确定</button>
			<button id="yc">押车</button>
		</p>
	</div>
	<div class="model" id="model">
		<div class="model-contain">
			<p>时间：<span id="time"></span></p>
			<p id="showAddress">地点：<span id="address"></span></p>
			<p class="mt-10">
				<button id="sure">确定</button>
				<button id="cancel">取消</button>
			</p>
		</div>
	</div>
	<div class="model" id="model1">
		<div class="model-contain">
			<p>时间：<span id="time1"></span></p>
			<p>
				<button id="uploadFile">上传附件</button>
				<input type="file" id="file">
			</p>
			<p class="mt-10">
				<button id="sure1">确定</button>
				<button id="cancel1">取消</button>
			</p>
		</div>
	</div>
	<!-- 通过 iframe 嵌入前端定位组件 --> 
     <iframe id="geoPage" width="0" height="0" frameborder=0 scrolling="no" style="position: absolute;z-index: -1000;" src="https://apis.map.qq.com/tools/geolocation?key=B7HBZ-EDACJ-3RLFY-FQTAD-442OF-IWFOR&referer=myapp&effect=zoom" allow="geolocation"></iframe> 
     <!-- 接收到位置信息后 通过 iframe 嵌入位置标注组件 --> 
     <!-- <iframe id="markPage" width="100%" height="70%" frameborder=0 scrolling="no" src=""></iframe>  -->
	<script type="text/javascript" src="../js/moment.js"></script>
	<script type="text/javascript" src="../js/jquery.js"></script>
	<script type="text/javascript" src="../js/common.js"></script>
	<script type="text/javascript" src="../js/jquery.cookie.js"></script>
	<script type="text/javascript">
		(function(){
			window.addEventListener('message', function(event) { 
		        // 接收位置信息
		        var loc = event.data;
		        $('#address').html(loc.city+'，'+loc.addr)
		        // var markUrl = 'https://apis.map.qq.com/tools/poimarker?marker=coord:' + loc.lat + ',' +loc.lng+ ';title:我的位置;addr:' + (loc.addr||loc.city) + '&referer=myapp&key=B7HBZ-EDACJ-3RLFY-FQTAD-442OF-IWFOR';
		        // document.getElementById('markPage').src = markUrl;
		    }, false);

			$('#carNum').on('input',function(){
				getTable();
			})
			var CarNumber='';
			var CarNo='';
			var TradeId='';
			var BuildingNo='';
			var FloorNo='';
			function getTable(){
				myPost({
			        data: {
			          action: 'getReplenishTransportRecord',
			          carnumber: $('#carNum').val(),
			        },
			        successFn: function (data) {
			          if (data.status == 0) {
			          	console.log(data);
			          	CarNumber=data.result.CarNumber;
			          	CarNo=data.result.CarNo;
			          	TradeId=data.result.TradeId;
			          	BuildingNo=data.result.BuildingNo;
			          	FloorNo=data.result.FloorNo;
			          	var str="<tr><td>"+data.result.Forshort+"</td><td>"+data.result.CarNo+"</td></tr><tr><td colspan='2' style='text-align:left;'>"+data.result.ShipInfo+"</td></tr>"
			            $('#info').html(str);
			            str='';
			            for(var i=0;i<data.result.Records.length;i++){
			            	str+='<tr><td>'+(i-(-1))+'</td>';
			            	if(data.result.Records[i].TypeID==1){
			            		str+='<td>到厂时间</td><td><p>'+data.result.Records[i].CreateDateTime+'</p><p>'+data.result.Records[i].Address+'</p></td>';
			            	}
			            	if(data.result.Records[i].TypeID==2){
			            		str+='<td>出厂时间</td><td><p>'+data.result.Records[i].CreateDateTime+'</p><p>'+data.result.Records[i].Address+'</p></td>';
			            	}
			            	if(data.result.Records[i].TypeID==3){
			            		str+='<td>达到工地时间<td><p>'+data.result.Records[i].CreateDateTime+'</p><p>'+data.result.Records[i].Address+'</p></td>';
			            	}
			            	if(data.result.Records[i].TypeID==4){
			            		str+='<td>吊装完成时间<td><p>'+data.result.Records[i].CreateDateTime+'</p><p>'+data.result.Records[i].Address+'</p></td>';
			            	}
			            	if(data.result.Records[i].TypeID==5){
			            		str+='<td>押车原因</td><td></td>';
			            	}
							str+='<td>'+data.result.Records[i].CreateBy+'</td><td>'+data.result.Records[i].GroupUserName+'</td></tr>';
			            }
			            $('#list').html(str);
			          }
			        }
			      });
			}
			var type=0;
			function getTimeNow(){
				var time=new Date();
				var date=time.getFullYear()+'/'+(time.getMonth()+1)+'/'+time.getDate()+' '+time.getHours()+':'+time.getMinutes();
				return moment().format('YYYY-MM-DD');
			}
			$('#setTime').on('click',function(){
				type=1;
				$('#model').show();
				$('#time').html(getTimeNow());
			});
			$('#arrive').on('click',function(){
				type=2;
				$('#model').show();
				$('#time').html(getTimeNow());
			});
			$('#dzwcqr').on('click',function(){
				type=3;
				$('#model').show();
				$('#showAddress').hide();
				$('#time').html(getTimeNow());
			});
			$('#sure').on('click',function(){
				$('#showAddress').show();
				$('#model').hide();
				if(type===1) inFactory();
				if(type===2) atConstruction();
				if(type===3) diaoZhuang();
			})
			$('#cancel,#cancel1').on('click',function(){
				$('#showAddress').show();
				$('#model,#model1').hide();
			});
			$('#goToLogin').on('click',function(){
				document.location.href = './login.html';
			});
			// getUserInfo();
			// function getUserInfo(){
			// 	myPost({
			//         data: {
			//           action: 'userinfo',
			//           openid: ''
			//         },
			//         successFn: function (data) {
			//           if (data.status == 0) {
			//           	console.log(data);
			//           }
			//         }
			//       });
			// }
			function inFactory(){
				myPost({
			        data: {
			          action: 'setReplenishTransportRecord',
			          typeid: 1,
			          address: $('#address').html(),
			          createdatetime: $('#time').html(),
			          tradeId: TradeId,
			          buildingno: BuildingNo,
			          floorno: FloorNo,
			          carno: CarNo,
			          carnumber: CarNumber,
			        },
			        successFn: function (data) {
			          if (data.status == 0) {
			          	$('#model').hide();
						getTable();
			          }
			          window.alert(data.msg)
			        }
			      });
			}
			$('#outF').on('click',function(){
				$('#time1').html(getTimeNow());
				$('#model1').show();
			})
			$('#uploadFile').on('click',function(){
				$('#file').click();
			})
			$('#sure1').on('click',function(){
				outFactory();
			})
			function outFactory(){
				var oFiles = document.getElementById("file").files;
				var params = new FormData();
				console.log(params);
				params.append('action','setReplenishTransportRecord');
				params.append('typeid',2);
				params.append('col01',oFiles[0]);
				params.append('createdatetime',$('#time1').html());
				params.append('tradeId',TradeId);
				params.append('buildingno',BuildingNo);
				params.append('floorno',FloorNo);
				params.append('carno',CarNo);
				params.append('carnumber',CarNumber);

				$.ajax({
					type: "POST",
				    url: url,
				    dataType: "json",
				    cache: false,
				    contentType: false,
				    processData: false,
				    data: params,
				    // {
			     //      action: 'setReplenishTransportRecord',
			     //      typeid: 2,
			     //      col01: oFiles[0],
			     //      createdatetime: $('#time1').html(),
			     //      tradeId: TradeId,
			     //      buildingno: BuildingNo,
			     //      floorno: FloorNo,
			     //    },
				    success: function (data) {
			          if (data.status == 0) {
						$('#model1').hide();
						getTable();
			          }
			          window.alert(data.msg)
			        },
				})
				// myPost({
			 //        data: {
			 //          action: 'setReplenishTransportRecord',
			 //          typeid: 2,
			 //          col01: params,
			 //          createdatetime: $('#time1').html(),
			 //          tradeId: TradeId,
			 //          buildingno: BuildingNo,
			 //          floorno: FloorNo,
			 //        },
			 //        successFn: function (data) {
			 //          if (data.status == 0) {
			 //          	console.log(data);
			 //          }
			 //        }
			 //      });
			}
			function atConstruction(){
				myPost({
			        data: {
			          action: 'setReplenishTransportRecord',
			          typeid: 3,
			          address: $('#address').html(),
			          createdatetime: $('#time').html(),
			          tradeId: TradeId,
			          buildingno: BuildingNo,
			          floorno: FloorNo,
			          carno: CarNo,
			          carnumber: CarNumber,
			        },
			        successFn: function (data) {
			          if (data.status == 0) {
			          	$('#model').hide();
						getTable();
			          }
			          window.alert(data.msg)
			        }
			      });
			}
			function diaoZhuang(){
				myPost({
			        data: {
			          action: 'setReplenishTransportRecord',
			          typeid: 4,
			          createdatetime: $('#time').html(),
			          tradeId: TradeId,
			          buildingno: BuildingNo,
			          floorno: FloorNo,
			          carno: CarNo,
			          carnumber: CarNumber,
			        },
			        successFn: function (data) {
			          if (data.status == 0) {
			          	$('#model').hide();
						getTable();
			          }
			          window.alert(data.msg)
			        }
			      });
			}
			$('#yc').on('click',function(){
				yaChe();
			})
			function yaChe(){
				myPost({
			        data: {
			          action: 'setReplenishTransportRecord',
			          typeid: 5,
			          createby: $('#people').html(),
			          tradeId: TradeId,
			          buildingno: BuildingNo,
			          floorno: FloorNo,
			          carno: CarNo,
			          carnumber: CarNumber,
			          createdatetime: getTimeNow(),
			        },
			        successFn: function (data) {
			          if (data.status == 0) {
						getTable();
			          }
			          window.alert(data.msg)
			        }
			      });
			}
			function getOpenID(){
				myGet({
					url: 'https://graph.z.qq.com/moc2/me',
					data: access_token
				})
			}
		})();
	</script>
</body>
</html>